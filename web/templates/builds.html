{{define "title"}}Build Status{{end}}

{{define "extra-css"}}<link rel="stylesheet" href="static/builds.css">{{end}}

{{define "stats"}}
<div class="stats">
    Last updated: {{.LastUpdate.Format "Jan 2, 15:04:05 MST"}} |
    Repositories: {{len .Repositories}}
</div>
{{if .RepoNames}}
<form class="filter-form" id="repo-filter-form" method="get" action="builds">
    <label for="repo-filter" class="sr-only">Filter by repository</label>
    <select id="repo-filter" name="repo">
        <option value="">All repositories</option>
        {{range .RepoNames}}
        <option value="{{.}}"{{if eq . $.Repo}} selected{{end}}>{{.}}</option>
        {{end}}
    </select>
</form>
{{end}}
{{end}}

{{define "build-lane"}}
<div class="build-lane">
    <span class="lane-branch">{{.Branch}}</span>
    {{if .HasChecks}}
        <div class="lane-strip">
            {{range .Checks}}
            <a href="{{.URL}}" target="_blank" rel="noopener noreferrer"
               aria-label="{{.Name}}: {{if or (eq .Status "in_progress") (eq .Status "queued") (eq .Status "waiting") (eq .Status "pending")}}Running{{else if eq .Conclusion "cancelled"}}Cancelled{{else}}{{.Conclusion}}{{end}}"
               data-tooltip="{{.Name}}: {{if or (eq .Status "in_progress") (eq .Status "queued") (eq .Status "waiting") (eq .Status "pending")}}Running{{else if eq .Conclusion "cancelled"}}Cancelled{{else}}{{.Conclusion}}{{end}}"
               class="lane-dot tooltip-dot {{if or (eq .Status "in_progress") (eq .Status "queued") (eq .Status "waiting") (eq .Status "pending")}}status-running{{else if or (eq .Conclusion "failure") (eq .Conclusion "timed_out") (eq .Conclusion "action_required") (eq .Conclusion "cancelled")}}status-failure{{else if eq .Conclusion "success"}}status-success{{else}}status-neutral{{end}}">
            </a>
            {{end}}
        </div>
        <span class="lane-counts">
            <span class="count-success{{if eq .SuccessCount 0}} count-zero{{end}}">{{.SuccessCount}} passed</span>
            <span class="count-failure{{if eq .FailureCount 0}} count-zero{{end}}">{{.FailureCount}} failed</span>
            <span class="count-running{{if eq .RunningCount 0}} count-zero{{end}}">{{.RunningCount}} running</span>
        </span>
    {{else}}
    <span class="lane-empty">No checks</span>
    {{end}}
</div>
{{end}}

{{define "content"}}
{{if not .Repositories}}
<div class="empty-state">
    <p>No build status data available yet.</p>
    {{if .LastUpdate.IsZero}}<p class="empty-state-hint">Data is still loading. Check back shortly.</p>{{end}}
</div>
{{else}}
<div class="build-list">
    {{range .Repositories}}
    {{$hasDetails := .HasDetails}}
    <div class="build-row {{if $hasDetails}}has-details{{end}}{{if .Stale}} stale-row{{end}}" {{if $hasDetails}}role="button" tabindex="0" aria-expanded="false" aria-label="Toggle details for {{.Name}}"{{end}}>
        <div class="build-row-header">
            <a class="build-repo" href="https://github.com/{{$.Organization}}/{{.Name}}" target="_blank" rel="noopener noreferrer">{{.Name}}</a>
            <div class="build-lanes">
                {{range .Branches}}
                {{template "build-lane" .}}
                {{end}}
            </div>
            {{if $hasDetails}}
            <span class="build-chevron" aria-hidden="true"></span>
            {{else}}
            <span class="build-chevron-spacer" aria-hidden="true"></span>
            {{end}}
        </div>
        {{if $hasDetails}}
        <div class="build-details">
            <div class="build-details-inner">
                {{range .Branches}}
                    {{if or (gt .FailureCount 0) (gt .RunningCount 0)}}
                    <div class="detail-branch">
                        <span class="detail-branch-label">{{.Branch}}</span>
                        <ul class="detail-checks">
                            {{range .Checks}}
                                {{if or (eq .Conclusion "failure") (eq .Conclusion "timed_out") (eq .Conclusion "action_required") (eq .Conclusion "cancelled") (eq .Status "in_progress") (eq .Status "queued") (eq .Status "waiting") (eq .Status "pending")}}
                                <li class="detail-check">
                                    <span class="detail-indicator {{if or (eq .Status "in_progress") (eq .Status "queued") (eq .Status "waiting") (eq .Status "pending")}}status-running{{else}}status-failure{{end}}"></span>
                                    <a href="{{.URL}}" target="_blank" rel="noopener noreferrer">{{.Name}}</a>
                                </li>
                                {{end}}
                            {{end}}
                        </ul>
                    </div>
                    {{end}}
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
    {{end}}
</div>
{{end}}
{{end}}
