<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECMWF GitHub Dashboard - Pull Requests</title>
    <link rel="stylesheet" href="/static/{{.CSSFile}}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ECMWF GitHub Dashboard - Pull Requests</h1>
            <nav class="nav-links">
                <a href="/">Issues</a>
                <a href="/pulls" class="active">Pull Requests</a>
            </nav>
            <div class="header-info">
                <div class="stats">
                    Last updated: {{.LastUpdate.Format "Jan 2, 15:04:05 MST"}} | 
                    Total PRs: {{.TotalPRs}} | 
                    Showing {{if .PullRequests}}{{add (mul (add .CurrentPage -1) 100) 1}}-{{add (mul (add .CurrentPage -1) 100) (len .PullRequests)}}{{else}}0{{end}} of {{.TotalPRs}}
                </div>
                <div class="css-selector">
                    <div style="position: relative;">
                        <label for="refresh-select">Refresh</label>
                        <select id="refresh-select">
                            <option value="0">Off</option>
                            <option value="60000">1 min</option>
                            <option value="300000">5 min</option>
                            <option value="600000">10 min</option>
                            <option value="900000">15 min</option>
                        </select>
                    </div>
                    <div>
                        <label for="style-select">Theme</label>
                        <select id="style-select" onchange="changeStyle(this)">
                            {{range .CSSFiles}}
                            <option value="{{.}}" {{if eq . $.CSSFile}}selected{{end}}>{{.}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="issues-table">
            <table>
                <thead>
                    <tr>
                        <th>
                            <a href="?sort=repo&order={{if and (eq .Sort "repo") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Repository
                                <span class="sort-arrow {{if eq .Sort "repo"}}active{{end}}">
                                    {{if and (eq .Sort "repo") (eq .Order "asc")}}‚Üë{{else if and (eq .Sort "repo") (eq .Order "desc")}}‚Üì{{else}}‚Üï{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=number&order={{if and (eq .Sort "number") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                #
                                <span class="sort-arrow {{if eq .Sort "number"}}active{{end}}">
                                    {{if and (eq .Sort "number") (eq .Order "asc")}}‚Üë{{else if and (eq .Sort "number") (eq .Order "desc")}}‚Üì{{else}}‚Üï{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=title&order={{if and (eq .Sort "title") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Title
                                <span class="sort-arrow {{if eq .Sort "title"}}active{{end}}">
                                    {{if and (eq .Sort "title") (eq .Order "asc")}}‚Üë{{else if and (eq .Sort "title") (eq .Order "desc")}}‚Üì{{else}}‚Üï{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=author&order={{if and (eq .Sort "author") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Author
                                <span class="sort-arrow {{if eq .Sort "author"}}active{{end}}">
                                    {{if and (eq .Sort "author") (eq .Order "asc")}}‚Üë{{else if and (eq .Sort "author") (eq .Order "desc")}}‚Üì{{else}}‚Üï{{end}}
                                </span>
                            </a>
                        </th>
                        <th>Branch</th>
                        <th>Review</th>
                        <th>Merge Status</th>
                        <th>üí¨</th>
                        <th>
                            <a href="?sort=updated&order={{if and (eq .Sort "updated") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Last Activity
                                <span class="sort-arrow {{if eq .Sort "updated"}}active{{end}}">
                                    {{if and (eq .Sort "updated") (eq .Order "asc")}}‚Üë{{else if and (eq .Sort "updated") (eq .Order "desc")}}‚Üì{{else}}‚Üï{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=created&order={{if and (eq .Sort "created") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Created
                                <span class="sort-arrow {{if eq .Sort "created"}}active{{end}}">
                                    {{if and (eq .Sort "created") (eq .Order "asc")}}‚Üë{{else if and (eq .Sort "created") (eq .Order "desc")}}‚Üì{{else}}‚Üï{{end}}
                                </span>
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {{range .PullRequests}}
                    <tr>
                        <td>{{.Repository}}</td>
                        <td class="issue-number">#{{.Number}}</td>
                        <td>
                            <div>
                                <a href="{{.URL}}" target="_blank">
                                    {{if .Draft}}<span class="draft-badge">Draft</span> {{end}}{{.Title}}
                                </a>
                            </div>
                            {{if .Labels}}
                            <div class="labels">
                                {{range .Labels}}
                                <span class="label" style="background-color: #{{.Color}}">{{.Name}}</span>
                                {{end}}
                            </div>
                            {{end}}
                            {{if .Checks}}
                            <div class="checks-container">
                                <div class="checks-matrix">
                                    {{range .Checks}}
                                    <a href="{{.URL}}" target="_blank" title="{{.Name}}: {{if eq .Status "completed"}}{{.Conclusion}}{{else}}{{.Status}}{{end}}" 
                                       class="check-dot {{if eq .Status "in_progress"}}running{{else if eq .Conclusion "success"}}success{{else if eq .Conclusion "failure"}}failure{{else}}neutral{{end}}">
                                    </a>
                                    {{end}}
                                </div>
                                <span class="checks-summary">
                                    {{$success := 0}}{{$failure := 0}}{{$running := 0}}
                                    {{range .Checks}}
                                        {{if eq .Status "in_progress"}}{{$running = add $running 1}}
                                        {{else if eq .Conclusion "success"}}{{$success = add $success 1}}
                                        {{else if eq .Conclusion "failure"}}{{$failure = add $failure 1}}
                                        {{end}}
                                    {{end}}
                                    {{if gt $success 0}}<span class="check-count success">{{$success}} ‚úì</span>{{end}}
                                    {{if gt $failure 0}}<span class="check-count failure">{{$failure}} ‚úó</span>{{end}}
                                    {{if gt $running 0}}<span class="check-count running">{{$running}} ‚è≥</span>{{end}}
                                </span>
                            </div>
                            {{end}}
                        </td>
                        <td>
                            <div class="author-info">
                                <img src="{{.AuthorAvatar}}" alt="{{.Author}}" class="author-avatar">
                                <a href="https://github.com/{{.Author}}" target="_blank">{{.Author}}</a>
                                {{if .IsExternal}}
                                <span class="external-badge">external</span>
                                {{end}}
                            </div>
                        </td>
                        <td class="branch-info">
                            <span title="{{.BaseBranch}} ‚Üê {{.HeadBranch}}">{{.BaseBranch}} ‚Üê {{.HeadBranch}}</span>
                        </td>
                        <td>
                            <div class="review-status {{.ReviewStatus}}">
                                {{if eq .ReviewStatus "approved"}}‚úì Approved
                                {{else if eq .ReviewStatus "changes_requested"}}‚ö† Changes
                                {{else}}‚óã Pending{{end}}
                            </div>
                            {{if .Reviewers}}
                            <div class="reviewers">
                                {{range .Reviewers}}
                                <img src="{{.Avatar}}" alt="{{.Login}}" title="{{.Login}}: {{.State}}" 
                                     class="reviewer-avatar {{if eq .State "APPROVED"}}approved{{else if eq .State "CHANGES_REQUESTED"}}changes{{end}}">
                                {{end}}
                            </div>
                            {{end}}
                        </td>
                        <td>
                            <span class="merge-status {{.MergeableState}}">
                                {{if eq .MergeableState "clean"}}‚úì Ready
                                {{else if eq .MergeableState "blocked"}}‚õî Blocked
                                {{else if eq .MergeableState "dirty"}}‚ö† Conflicts
                                {{else}}{{.MergeableState}}{{end}}
                            </span>
                        </td>
                        <td class="comments-count">
                            <span title="{{.Comments}} comments, {{.ReviewComments}} review comments">
                                {{.Comments}}/{{.ReviewComments}}
                            </span>
                        </td>
                        <td class="time">{{.UpdatedAt.Format "Jan 2, 2006"}}</td>
                        <td class="time">{{.CreatedAt.Format "Jan 2, 2006"}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        {{if gt .TotalPages 1}}
        <div class="pagination">
            {{if gt .CurrentPage 1}}
                <a href="?sort={{.Sort}}&order={{.Order}}&page=1">¬´ First</a>
                <a href="?sort={{.Sort}}&order={{.Order}}&page={{.CurrentPage | add -1}}">‚Äπ Previous</a>
            {{else}}
                <a class="disabled">¬´ First</a>
                <a class="disabled">‚Äπ Previous</a>
            {{end}}

            <span class="pagination-info">Page {{.CurrentPage}} of {{.TotalPages}}</span>

            {{if lt .CurrentPage .TotalPages}}
                <a href="?sort={{.Sort}}&order={{.Order}}&page={{.CurrentPage | add 1}}">Next ‚Ä∫</a>
                <a href="?sort={{.Sort}}&order={{.Order}}&page={{.TotalPages}}">Last ¬ª</a>
            {{else}}
                <a class="disabled">Next ‚Ä∫</a>
                <a class="disabled">Last ¬ª</a>
            {{end}}
        </div>
        {{end}}
    </div>
    
    <script>
    function changeStyle(select) {
        const newCSS = select.value;
        const link = document.querySelector('link[rel="stylesheet"]');
        link.href = `/static/${newCSS}`;
        
        localStorage.setItem('preferredCSS', newCSS);
        
        const url = new URL(window.location);
        url.searchParams.set('css', newCSS);
        window.history.replaceState({}, '', url);
    }

    // Refresh functionality
    (function() {
        const dropdown = document.getElementById("refresh-select");
        const saved = localStorage.getItem("refresh-interval");
        if (saved) dropdown.value = saved;

        let timer = null;

        function setRefresh(interval) {
            if (timer) clearInterval(timer);
            if (interval > 0) {
                timer = setInterval(() => {
                    window.location.reload();
                }, interval);
            }
        }

        dropdown.addEventListener("change", () => {
            const interval = parseInt(dropdown.value, 10);
            localStorage.setItem("refresh-interval", dropdown.value);
            setRefresh(interval);
        });

        setRefresh(parseInt(dropdown.value, 10));
    })();
    
    window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const cssParam = urlParams.get('css');
        const savedCSS = localStorage.getItem('preferredCSS');
        
        if (cssParam) {
            const select = document.getElementById('style-select');
            select.value = cssParam;
            changeStyle(select);
        } else if (savedCSS) {
            const select = document.getElementById('style-select');
            if (Array.from(select.options).some(opt => opt.value === savedCSS)) {
                select.value = savedCSS;
                changeStyle(select);
            }
        }
    });
    </script>
</body>
</html>