<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECMWF GitHub Dashboard</title>
    <link rel="stylesheet" href="static/{{.CSSFile}}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ECMWF GitHub Dashboard - Issues</h1>
            <nav class="nav-links">
                <a href="builds">Build Status</a>
                <a href="pulls">Pull Requests</a>
                <a href="issues" class="active">Issues</a>
            </nav>
            <div class="header-info">
                <div class="stats">
                    Last updated: {{.LastUpdate.Format "Jan 2, 15:04:05 MST"}} | 
                    Total issues: {{.TotalIssues}} | 
                    Showing {{if .Issues}}{{add (mul (add .CurrentPage -1) 100) 1}}-{{add (mul (add .CurrentPage -1) 100) (len .Issues)}}{{else}}0{{end}} of {{.TotalIssues}}
                </div>
                <div class="css-selector">
                    <div style="position: relative;">
                        <label for="refresh-select">Refresh</label>
                        <select id="refresh-select">
                            <option value="0">Off</option>
                            <option value="60000">1 min</option>
                            <option value="300000">5 min</option>
                            <option value="600000">10 min</option>
                            <option value="900000">15 min</option>
                        </select>
                    </div>
                    <div>
                        <label for="style-select">Theme</label>
                        <select id="style-select" onchange="changeStyle(this)">
                            {{range .CSSFiles}}
                            <option value="{{.}}" {{if eq . $.CSSFile}}selected{{end}}>{{.}}</option>
                            {{end}}
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="issues-table">
            <table>
                <thead>
                    <tr>
                        <th>
                            <a href="?sort=repo&order={{if and (eq .Sort "repo") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Repository
                                <span class="sort-arrow {{if eq .Sort "repo"}}active{{end}}">
                                    {{if and (eq .Sort "repo") (eq .Order "asc")}}↑{{else if and (eq .Sort "repo") (eq .Order "desc")}}↓{{else}}↕{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=number&order={{if and (eq .Sort "number") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                #
                                <span class="sort-arrow {{if eq .Sort "number"}}active{{end}}">
                                    {{if and (eq .Sort "number") (eq .Order "asc")}}↑{{else if and (eq .Sort "number") (eq .Order "desc")}}↓{{else}}↕{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=title&order={{if and (eq .Sort "title") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Title
                                <span class="sort-arrow {{if eq .Sort "title"}}active{{end}}">
                                    {{if and (eq .Sort "title") (eq .Order "asc")}}↑{{else if and (eq .Sort "title") (eq .Order "desc")}}↓{{else}}↕{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=author&order={{if and (eq .Sort "author") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Author
                                <span class="sort-arrow {{if eq .Sort "author"}}active{{end}}">
                                    {{if and (eq .Sort "author") (eq .Order "asc")}}↑{{else if and (eq .Sort "author") (eq .Order "desc")}}↓{{else}}↕{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=updated&order={{if and (eq .Sort "updated") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Last Activity
                                <span class="sort-arrow {{if eq .Sort "updated"}}active{{end}}">
                                    {{if and (eq .Sort "updated") (eq .Order "asc")}}↑{{else if and (eq .Sort "updated") (eq .Order "desc")}}↓{{else}}↕{{end}}
                                </span>
                            </a>
                        </th>
                        <th>
                            <a href="?sort=created&order={{if and (eq .Sort "created") (eq .Order "asc")}}desc{{else}}asc{{end}}&page={{.CurrentPage}}">
                                Created
                                <span class="sort-arrow {{if eq .Sort "created"}}active{{end}}">
                                    {{if and (eq .Sort "created") (eq .Order "asc")}}↑{{else if and (eq .Sort "created") (eq .Order "desc")}}↓{{else}}↕{{end}}
                                </span>
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {{range .Issues}}
                    <tr>
                        <td>{{.Repository}}</td>
                        <td class="issue-number">#{{.Number}}</td>
                        <td>
                            <div>
                                <a href="{{.URL}}" target="_blank">{{.Title}}</a>
                            </div>
                            {{if .Labels}}
                            <div class="labels">
                                {{range .Labels}}
                                <span class="label" style="background-color: #{{.Color}}">{{.Name}}</span>
                                {{end}}
                            </div>
                            {{end}}
                        </td>
                        <td>
                            <div class="author-info">
                                <img src="{{.AuthorAvatar}}" alt="{{.Author}}" class="author-avatar">
                                <a href="https://github.com/{{.Author}}" target="_blank">{{.Author}}</a>
                                {{if .IsExternal}}
                                <span class="external-badge">external</span>
                                {{end}}
                            </div>
                        </td>
                        <td class="time">{{.UpdatedAt.Format "Jan 2, 2006"}}</td>
                        <td class="time">{{.CreatedAt.Format "Jan 2, 2006"}}</td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>

        {{if gt .TotalPages 1}}
        <div class="pagination">
            {{if gt .CurrentPage 1}}
                <a href="?sort={{.Sort}}&order={{.Order}}&page=1">« First</a>
                <a href="?sort={{.Sort}}&order={{.Order}}&page={{.CurrentPage | add -1}}">‹ Previous</a>
            {{else}}
                <a class="disabled">« First</a>
                <a class="disabled">‹ Previous</a>
            {{end}}

            <span class="pagination-info">Page {{.CurrentPage}} of {{.TotalPages}}</span>

            {{if lt .CurrentPage .TotalPages}}
                <a href="?sort={{.Sort}}&order={{.Order}}&page={{.CurrentPage | add 1}}">Next ›</a>
                <a href="?sort={{.Sort}}&order={{.Order}}&page={{.TotalPages}}">Last »</a>
            {{else}}
                <a class="disabled">Next ›</a>
                <a class="disabled">Last »</a>
            {{end}}
        </div>
        {{end}}
    </div>
    
    <script>
    function changeStyle(select) {
        const newCSS = select.value;
        const link = document.querySelector('link[rel="stylesheet"]');
        link.href = `static/${newCSS}`;
        
        // Store preference
        localStorage.setItem('preferredCSS', newCSS);
        
        // Update URL parameter
        const url = new URL(window.location);
        url.searchParams.set('css', newCSS);
        window.history.replaceState({}, '', url);
    }

    // Refresh functionality
    (function() {
        const dropdown = document.getElementById("refresh-select");
        const saved = localStorage.getItem("refresh-interval");
        if (saved) dropdown.value = saved;

        let timer = null;

        function setRefresh(interval) {
            if (timer) clearInterval(timer);
            if (interval > 0) {
                timer = setInterval(() => {
                    window.location.reload();
                }, interval);
            }
        }

        dropdown.addEventListener("change", () => {
            const interval = parseInt(dropdown.value, 10);
            localStorage.setItem("refresh-interval", dropdown.value);
            setRefresh(interval);
        });

        // Set initial interval if saved
        setRefresh(parseInt(dropdown.value, 10));
    })();
    
    // Load preferred style on page load
    window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const cssParam = urlParams.get('css');
        const savedCSS = localStorage.getItem('preferredCSS');
        
        if (cssParam) {
            const select = document.getElementById('style-select');
            select.value = cssParam;
            changeStyle(select);
        } else if (savedCSS) {
            const select = document.getElementById('style-select');
            if (Array.from(select.options).some(opt => opt.value === savedCSS)) {
                select.value = savedCSS;
                changeStyle(select);
            }
        }
    });
    </script>
</body>
</html>